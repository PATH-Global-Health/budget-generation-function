<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="PATH MACEPA">
<meta name="dcterms.date" content="2025-09-24">

<title>Budget Generation Function — Partner Integration Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="mermaid-theme" content="forest">
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#system-overview" id="toc-system-overview" class="nav-link active" data-scroll-target="#system-overview"><span class="header-section-number">1</span> System overview</a></li>
  <li><a href="#data-contracts-upload-templates" id="toc-data-contracts-upload-templates" class="nav-link" data-scroll-target="#data-contracts-upload-templates"><span class="header-section-number">2</span> Data contracts (upload templates)</a>
  <ul class="collapse">
  <li><a href="#scenario-template-intervention-mix" id="toc-scenario-template-intervention-mix" class="nav-link" data-scroll-target="#scenario-template-intervention-mix"><span class="header-section-number">2.1</span> Scenario template (intervention mix)</a></li>
  <li><a href="#unit-cost-template" id="toc-unit-cost-template" class="nav-link" data-scroll-target="#unit-cost-template"><span class="header-section-number">2.2</span> Unit Cost template</a></li>
  </ul></li>
  <li><a href="#core-function-interface" id="toc-core-function-interface" class="nav-link" data-scroll-target="#core-function-interface"><span class="header-section-number">3</span> Core function interface</a>
  <ul class="collapse">
  <li><a href="#function-arguments" id="toc-function-arguments" class="nav-link" data-scroll-target="#function-arguments"><span class="header-section-number">3.1</span> Function arguments</a>
  <ul class="collapse">
  <li><a href="#currency-columns-expected-in-cost_data" id="toc-currency-columns-expected-in-cost_data" class="nav-link" data-scroll-target="#currency-columns-expected-in-cost_data"><span class="header-section-number">3.1.1</span> Currency columns expected in <code>cost_data</code></a></li>
  <li><a href="#spatial-planning-unit-spu-behavior" id="toc-spatial-planning-unit-spu-behavior" class="nav-link" data-scroll-target="#spatial-planning-unit-spu-behavior"><span class="header-section-number">3.1.2</span> Spatial planning unit (SPU) behavior</a></li>
  <li><a href="#assumptions-interface" id="toc-assumptions-interface" class="nav-link" data-scroll-target="#assumptions-interface"><span class="header-section-number">3.1.3</span> Assumptions interface</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#processing-workflow" id="toc-processing-workflow" class="nav-link" data-scroll-target="#processing-workflow"><span class="header-section-number">4</span> Processing workflow</a>
  <ul class="collapse">
  <li><a href="#environment-inputs" id="toc-environment-inputs" class="nav-link" data-scroll-target="#environment-inputs"><span class="header-section-number">4.1</span> Environment &amp; inputs</a></li>
  <li><a href="#assumption-parsing-defaults" id="toc-assumption-parsing-defaults" class="nav-link" data-scroll-target="#assumption-parsing-defaults"><span class="header-section-number">4.2</span> Assumption parsing &amp; defaults</a></li>
  <li><a href="#quantification-by-intervention" id="toc-quantification-by-intervention" class="nav-link" data-scroll-target="#quantification-by-intervention"><span class="header-section-number">4.3</span> Quantification by intervention</a>
  <ul class="collapse">
  <li><a href="#itn-campaign-code_itn_campaign" id="toc-itn-campaign-code_itn_campaign" class="nav-link" data-scroll-target="#itn-campaign-code_itn_campaign"><span class="header-section-number">4.3.1</span> ITN — Campaign (<code>code_itn_campaign</code>)</a></li>
  <li><a href="#itn-routine-code_itn_routine" id="toc-itn-routine-code_itn_routine" class="nav-link" data-scroll-target="#itn-routine-code_itn_routine"><span class="header-section-number">4.3.2</span> ITN — Routine (<code>code_itn_routine</code>)</a></li>
  <li><a href="#iptp-code_iptp" id="toc-iptp-code_iptp" class="nav-link" data-scroll-target="#iptp-code_iptp"><span class="header-section-number">4.3.3</span> IPTp (<code>code_iptp</code>)</a></li>
  <li><a href="#smc-code_smc" id="toc-smc-code_smc" class="nav-link" data-scroll-target="#smc-code_smc"><span class="header-section-number">4.3.4</span> SMC (<code>code_smc</code>)</a></li>
  <li><a href="#pmc-code_pmc" id="toc-pmc-code_pmc" class="nav-link" data-scroll-target="#pmc-code_pmc"><span class="header-section-number">4.3.5</span> PMC (<code>code_pmc</code>)</a></li>
  <li><a href="#vaccine-code_vacc" id="toc-vaccine-code_vacc" class="nav-link" data-scroll-target="#vaccine-code_vacc"><span class="header-section-number">4.3.6</span> Vaccine (<code>code_vacc</code>)</a></li>
  <li><a href="#baseline-assumptions-defaults-summary" id="toc-baseline-assumptions-defaults-summary" class="nav-link" data-scroll-target="#baseline-assumptions-defaults-summary"><span class="header-section-number">4.3.7</span> Baseline assumptions (defaults summary)</a></li>
  </ul></li>
  <li><a href="#intervention-costing" id="toc-intervention-costing" class="nav-link" data-scroll-target="#intervention-costing"><span class="header-section-number">4.4</span> Intervention costing</a></li>
  <li><a href="#fixed-costs" id="toc-fixed-costs" class="nav-link" data-scroll-target="#fixed-costs"><span class="header-section-number">4.5</span> Fixed Costs</a></li>
  <li><a href="#output-data-frame" id="toc-output-data-frame" class="nav-link" data-scroll-target="#output-data-frame"><span class="header-section-number">4.6</span> Output data frame</a></li>
  </ul></li>
  <li><a href="#full-core-function" id="toc-full-core-function" class="nav-link" data-scroll-target="#full-core-function"><span class="header-section-number">5</span> Full core function</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Budget Generation Function — Partner Integration Guide</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>PATH MACEPA </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p><strong>Purpose.</strong> This document explains how our current budget generation pipeline works end‑to‑end so partners can port the logic into their own platform. It covers data contracts (upload templates), core function interface, quantification &amp; costing methods per intervention, output schema, and items still under development.</p>
</blockquote>
<section id="system-overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> System overview</h1>
<p>The application ingests <strong>(a)</strong> intervention plans (“scenarios”) and <strong>(b)</strong> unit cost tables, validates and merges them with population denominators and assumptions, <strong>quantifies</strong> commodities/services by spatial planning unit (SPU), and multiplies by unit costs to produce a <strong>budget dataset</strong>. Outputs are then visualised and compared across scenarios.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  A[Scenario template] --&gt; C{generate_budget function}
  B[Unit cost template] --&gt; C{generate_budget function}
  C --&gt; D[Budget dataset - Quantities + Costs]
  D --&gt; E[Maps / Tables / Charts]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="data-contracts-upload-templates" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data contracts (upload templates)</h1>
<p>We currently have our tool set up so that we provide essential back-end data during application set-up (e.g.&nbsp;population data, spatial information, naming standarizations), see <a href="#nte-backenddata" class="quarto-xref">Note&nbsp;1</a> below for more information on these items.</p>
<p>The user is able to populate the web-application with two excel spreadsheets that are downloaded from the tool - the scenario or intervention mix template and the unit-cost template</p>
<div id="nte-backenddata" class="callout callout-style-default callout-note callout-titled" title="Backend Data">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;1: Backend Data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Below is a description of each of the sheets to be filled in and how to complete them - the essential baseline datasets required for the tool to generate a budget are <mark>highlighted.</mark></p>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 39%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th>Sheet Name (EN / FR)</th>
<th>Description</th>
<th>How to Populate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><mark>adm_names / admin_nom</mark></td>
<td>The application uses adm0, adm1, adm2 and adm3 as universal identifiers of spatial units throughout the tool. Here we include the</td>
<td><p>Add plain text to the empty column, this will then propogate throughout the tool UI.</p>
<p>e.g.&nbsp;Country, Region, Province</p>
<p>Only fill to the lowest spatial unit of intervention planning/budgeting</p></td>
</tr>
<tr class="even">
<td><mark>spatial-structure / structure-spatiale</mark></td>
<td><p>Names of the adm0, adm1,adm2 and adm3 if used areas.</p>
<p>This will be critical for naming conventions across templates and the UI elements.</p></td>
<td><p>Ensure that these names match with the versions in the shapefile that you will supply to the tool.</p>
<p>The landmass in sq_km can be calculated and appended from the shapefile if unknown.</p></td>
</tr>
<tr class="odd">
<td>urban-rural / urbain-rural</td>
<td>Optional identification of urban and rural spatial planning units.</td>
<td><p>1 = urban</p>
<p>0 = rural</p></td>
</tr>
<tr class="even">
<td><mark>population</mark></td>
<td>Population data required for intervention qunartification. Include population sizes for the smallest intervention planning unit and for at least three to five years into the future</td>
<td><p>Total population and key population groups are required (under 5s, 0-1s, 1-2s, vaccine population, pregnant women, 5-10s, urban population)</p>
<p>Ensure that all population columns are filled as they will be critical for quantifying intervention commodity needs and target populations.</p></td>
</tr>
<tr class="odd">
<td>facility-info / info-fosa</td>
<td>Health facility information - number of primary, secondary and tertiary health facilities per spatial planning unit</td>
<td>If required for any costing elements populate with the number of facilties of each type.</td>
</tr>
<tr class="even">
<td><mark>households / menages</mark></td>
<td>If IRS is being implemented this is critical. Specifically the total number of households or structures at the spatial planning unit.</td>
<td>If required for any costing elements populate with the number of households and a specific year if no year is included the tool will assume the same number of households for every year of the plan.</td>
</tr>
<tr class="odd">
<td>incidence / incidence</td>
<td>Historical routine case and incidence data can be used for projecting the expected number of cases for case management quantification.</td>
<td>Include for at least the 3 most recent years the number of confrimed, suspected and total malaria cases, population and incidence per 1000 population at the spatial planning unit.</td>
</tr>
<tr class="even">
<td>pfpr / prevalence</td>
<td>Optional to record for reference any prevalence data from DHS, MIS or modelled surfaces</td>
<td>Specify the year and age group of measurement and report pfpr on a 0-1 scale.</td>
</tr>
<tr class="odd">
<td>intervention-coverage / couverture-intervention</td>
<td>Optional to record for reference but could be used for budgeting at realistic coverage levels if warrented.</td>
<td>At the spatial planning unit specify for at recent years the coverage levels acheieved with previously delivered interventions with the option to record the numerator and denominator used in those calculations if available.</td>
</tr>
<tr class="even">
<td>sources</td>
<td>Record where data was sourced from and when.</td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="scenario-template-intervention-mix" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="scenario-template-intervention-mix"><span class="header-section-number">2.1</span> Scenario template (intervention mix)</h2>
<p><a href="manual-extras/scenario-template-EN.xlsx">Click here to download the scenario template</a>.</p>
<ul>
<li><strong>Sheets:</strong> each sheet corresponds to a year that was specified in the tool at download.</li>
<li><strong>Grain:</strong> each row is one spatial targeting unit e.g.&nbsp;Health Zone in DRC or LGA in Nigeria.</li>
<li><strong>SPU keys:</strong> <code>adm1</code>, <code>adm2</code>, <code>adm3</code> (as applicable to country), this data will be pre-populated by the tool at the correct level of intervention targeting – do not make changes to these values in cells.</li>
<li><strong>Descriptor fields:</strong> <code>scenario_name</code>, <code>scenario_description</code>, these get added to the scenario mix during upload back into the tool.</li>
<li><strong>Intervention targeting:</strong> <code>code_*</code> columns (0/1), one per deliverable intervention.</li>
<li><strong>Intervention type selectors:</strong> <code>type_*</code> columns (drop‑downs aligned one-to-one with <code>code_*</code>).</li>
</ul>
<p>The figure below gives an example of what this looks like.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="manual-extras/scenario-template-image-EN.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Intervention Mix Template"><img src="manual-extras/scenario-template-image-EN.png" class="img-fluid figure-img" alt="Intervention Mix Template"></a></p>
<figcaption>Intervention Mix Template</figcaption>
</figure>
</div>
<p>Once a plan has been specified by indicating what interventions are to be targeted where each year the user can save a local copy of this file. Return to the web application and upload the completed Excel file using the Upload button. Give the scenario a short name: e.g.&nbsp;“Plan 1 BAU” and a description: e.g.&nbsp;“Basic mix of interventions – mass campaigns, case management and targeted SMC” – making sure these are informative descriptions as it will be helpful when comparing plans.</p>
<blockquote class="blockquote">
<ul>
<li>Sheets are per year; one workbook can cover multiple years.</li>
<li>The app pre-populates SPU keys; users must not edit the geometry keys.</li>
<li>Some interventions are missing e.g.&nbsp;MDA and Entomological Surveillance and current specification for the type of Private Sector case management that is to be implemented and we are waiting on discussions with country programs to finalise this.</li>
</ul>
</blockquote>
</section>
<section id="unit-cost-template" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="unit-cost-template"><span class="header-section-number">2.2</span> Unit Cost template</h2>
<p><a href="manual-extras/cost-template-EN.xlsx">Click here to download the unit-cost template</a>.</p>
<ul>
<li><p><strong>Sheets:</strong> <code>Instructions</code> template on how to fill in the <code>unit-cost-data</code> sheet, we also include a <code>supplementary-data</code> sheet to highlight to the user they are able to add any addiditional sheets into the excel workbook for tracking line-lists or unit-cost calculations for example.</p></li>
<li><p><strong>Grain:</strong> one unit cost line per <code>(code_intervention, type_intervention, unit, cost_year_for_analysis)</code>.</p></li>
<li><p><strong>Required columns:</strong> Columns <strong>A : J</strong> are required for calculations and their <strong>names must not change</strong></p>
<ul>
<li><p><code>code_intervention</code>: Select from the drop down the correct intervention that cost relates to - the code will match with the columns in the <code>code_</code> cells of the scenario template.</p></li>
<li><p><code>type_intervention</code>: Select from the drop down list the specific type of intervention the cost relates to. These values relate to the <code>type_</code> column in the scenario template. If the user wants to include any <strong>fixed costs</strong> for an intervention this is also specified in this column e.g.&nbsp;Fixed costs for annual warehousing of bednets during a campaign. <strong>This value must be filled in for the application to include the unit-cost correctly</strong>.</p></li>
<li><p><code>cost_class</code>: Select from the drop down - <code>Procurement</code>, <code>Delivery</code>, <code>Operational</code>, <code>Support</code>, <code>Other</code> (with detail in <code>cost_class_other</code>).</p></li>
<li><p><code>cost_class_other</code>: If selecting <code>other</code> in <code>cost_class</code> detail what this is.</p></li>
<li><p><code>description</code>: Free text to provide a short description of the components of the unit cost e.g.&nbsp;<em>Net storage costs for Global Fund Warehousing per year</em></p></li>
<li><p><code>unit</code>: Select from the drop down list the specific unit for the cost e.g.&nbsp;<em>Per Net</em>, <em>Per Child</em>, <em>Per Dose</em>, <em>Per Year</em> etc. If the requried unit is not listed they can be added by the technical team.</p></li>
<li><p><code>local_currency_cost</code>: Monetary value for the specific unit cost in National Currency.</p></li>
<li><p><code>exchange_rate</code>: Exchange rate to convert from National to USD to populate unit cost values in the <code>usd_cost</code> column or vice versa with the <code>local_currency_cost</code> column.</p></li>
<li><p><code>usd_cost</code>: Monetary value for the specific unit cost in USD.</p></li>
<li><p><code>cost_year_for_analysis</code>: This value is the year of the operational plan that the unit cost should be used to calculate the budget for. If this column is left blank the same unit cost will be applied for every year of delivery in the specified plan. But there may be instances especially where the unit-cost is expected to change year on year e.g.&nbsp;Vaccine procurement as a result of changes in Gavi co-financing.</p></li>
</ul></li>
<li><p><strong>Addiditional columns:</strong> To allow for ease of conversion of unit cost estimates that are generated from historical data to current monetary values we include the following columns:</p>
<ul>
<li><p><code>original_unit_cost</code>: Unit-cost calculated from historial budgets or expenditures.</p></li>
<li><p><code>original_unit_cost_year</code>: The year of the data used to claculate the unit-cost.</p></li>
<li><p><code>inflation_factor</code>: Inflation rate applied to the <code>original_unit_cost</code> to scale to current or future values.</p></li>
<li><p><code>notes</code>: Any helpful details surrounding unit cost data or things to be aware of.</p></li>
<li><p><code>source</code>: Data source.</p></li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sheet cells <strong>do not</strong> contain pre-specified formulas it is up to the user to enter or calculate data as they see appropriate.</p>
<p>The template is prepopulated with some common interventions, types of intervention, cost classes and units – these rows can be edited and/or deleted as the user requires but ensure that for each intervention being delivered in the operational plan there are unit costs for the specific intervention and intervention type. You can add extra rows but if there are any missing critical items from the unit cost spreadsheet this should be discussed with the the technical team to integrate</p>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="manual-extras/unit-template-image-EN.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Unit-cost Template"><img src="manual-extras/unit-template-image-EN.png" class="img-fluid figure-img" alt="Unit-cost Template"></a></p>
<figcaption>Unit-cost Template</figcaption>
</figure>
</div>
</section>
</section>
<section id="core-function-interface" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Core function interface</h1>
<p>The engine is a single, pure function. We keep the name and signature identical across our different country instances so the app can call it uniformly. Any country specific modifications stem from changes to the input spreadsheets or core calculation logic.</p>
<p>The following details the <strong>base function</strong> that we include as a <em>template</em> building block for all of our country applications. Currently we do not include methodology for quantifying and costing all of the avaliable core malaria control interventions or support services as we intend to discuss and finalise methodology with our country partners during the CO-OP processes that are currently underway - see <a href="#nte-missing" class="quarto-xref">Note&nbsp;2</a> for more details on these.</p>
<p>The base function exists in the <a href="https://github.com/PATH-Global-Health/budget-generation-function/tree/main">budget-generation-function</a> repo <code>template</code> folder and the template for the full application exists in the <a href="https://github.com/PATH-Global-Health/malaria-budget-tool-template">malaria-budget-tool-template</a> repo.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This version is the suggested format and code to build into your own applications if you should choose - this version superceeds any perviously shared versions.</p>
<p>Once we have customised versions incorporating the specifics of the DRC and Nigeria we will update the country specific folders on the <a href="https://github.com/PATH-Global-Health/budget-generation-function/tree/main">budget-generation-function</a> repo and update you on this.</p>
</div>
</div>
<section id="function-arguments" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="function-arguments"><span class="header-section-number">3.1</span> Function arguments</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate detailed intervention budget from scenarios &amp; costs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Quantifies product/service needs from scenario coverage, applies unit costs,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' and returns a long-form budget suitable for tables/maps/plots.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scen_data Data frame of implementation scenarios. Must include columns:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - Spatial keys: `adm1`, `adm2` (and optionally `adm3`) depending on SPU.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - `year`, `scenario_name`, `scenario_description`</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - intervention code columns like `code_itn_campaign`, `code_itn_routine`, `code_iptp`,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'     `code_smc`, `code_pmc`, `code_vacc`, and corresponding `type_*` columns.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cost_data Data frame of unit/delivery costs containing at least:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `code_intervention`, `type_intervention`, `unit`, `local_currency_cost`, `usd_cost`,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   and `cost_year_for_analysis` (may be NA, matched to scenario year if so).</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param assumptions Character vector of "Label = value" strings; optional.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with columns (subset depends on SPU):</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `adm1`, `adm2`, `adm3`, `year`, `scenario_name`, `scenario_description`,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `cost_name`, `cost_description`, `code_intervention`, `type_intervention`,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `target_pop`, `unit`, `quantity`, `cost_class`, `currency`, `unit_cost`,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `cost_element`, `intervention_nice`, `assumptions_changes`, `assumption_type`, `plan_id`.</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Uses global `spatial_planning_unit` set to one of `"adm1"/"adm2"/"adm3"`.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Uses global `local_currency_symbol` (labels non-USD currency rows).</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Requires global `target_population` table with the necessary population columns.</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Parses assumptions from strings of the form `"Label = value"`.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Treats rows where `type_intervention == "Fixed cost"` as national fixed costs.</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Keeps both currencies by pivoting `*_cost` columns to `currency` and `unit_cost`.</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `plan_id` is derived from `scenario_name`, `cost_name`, and assumption state.</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>generate_budget <span class="ot">&lt;-</span> <span class="cf">function</span>(scen_data, cost_data, assumptions) {</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="currency-columns-expected-in-cost_data" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="currency-columns-expected-in-cost_data"><span class="header-section-number">3.1.1</span> Currency columns expected in <code>cost_data</code></h3>
<ul>
<li><code>local_currency_cost</code> and <code>usd_cost</code> are <strong>both</strong> supported. The function pivots these to a single <code>currency</code> column (values: <code>USD</code> or the <code>local_currency_symbol</code>) and a numeric <code>unit_cost</code>.</li>
<li>Costs will only be calculated if the <code>code_intervention</code> and <code>type_intervention</code> columns are filled as these are critical for our joins.</li>
</ul>
</section>
<section id="spatial-planning-unit-spu-behavior" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="spatial-planning-unit-spu-behavior"><span class="header-section-number">3.1.2</span> Spatial planning unit (SPU) behavior</h3>
<ul>
<li>SPU is read from the global <code>spatial_planning_unit</code>. Allowed values are <code>adm1</code>, <code>adm2</code>, <code>adm3</code>; any other value falls back to <code>adm2</code> with a warning.</li>
<li>Output includes only the geo keys for the active SPU level (e.g., <code>adm1</code> only for SPU=<code>adm1</code>; <code>adm1, adm2</code> for SPU=<code>adm2</code>, etc.).</li>
</ul>
</section>
<section id="assumptions-interface" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="assumptions-interface"><span class="header-section-number">3.1.3</span> Assumptions interface</h3>
<p>A key part of the budget generation is allowing the user to select in the application whether or not to accept key assumptions in the quantification methods. For example the Program may be interested in comparing scenarios where the number of vaccine doses is reduced, the target population for SMC is expanded to children under 10 or an intervention coverage decreases, all of these aspects can be incorporated through the assumption adjustments.</p>
<ul>
<li>Provide overrides as a <strong>character vector</strong> like <code>c("ITN Campaign: people per net = 1.8", "SMC: cycles = 4")</code>.</li>
<li>The parser evaluates the right-hand side; unknown labels are ignored with a warning.</li>
<li>The function computes a human-readable summary in <code>assumptions_changes</code> and flags baseline vs adjusted in <code>assumption_type</code>.</li>
</ul>
</section>
</section>
</section>
<section id="processing-workflow" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Processing workflow</h1>
<p>This reflects the exact steps in the current implementation and the units/labels emitted per intervention.</p>
<section id="environment-inputs" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="environment-inputs"><span class="header-section-number">4.1</span> Environment &amp; inputs</h2>
<ol type="1">
<li><strong>SPU &amp; currency</strong>: read <code>spatial_planning_unit</code> and <code>local_currency_symbol</code> from globals; validate SPU; derive <code>spu_cols</code>.</li>
<li><strong>Scenario summary (console)</strong>: identify all <code>code_*</code> columns, coerce to 0/1, and print a per-intervention targeted-area count by year.</li>
<li><strong>Cost data prep</strong>:
<ul>
<li>Filter to rows with <code>local_currency_cost</code> present to remove empty rows.</li>
<li>Normalize <code>cost_year_for_analysis</code> to integer.</li>
<li><strong>Year expansion &amp; matching</strong>: cross scenario years with cost rows; if a cost row’s <code>cost_year_for_analysis</code> is <code>NA</code>, substitute scenario <code>year</code>; finally filter to <code>cost_year_for_analysis == year</code>.</li>
</ul></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># --- ENV OPTIONS ----------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># spatial level + currency symbol</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  spu <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"spatial_planning_unit"</span>, <span class="at">envir =</span> .GlobalEnv) <span class="sc">%||%</span> <span class="st">"adm2"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  local_symbol <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"local_currency_symbol"</span>, <span class="at">envir =</span> .GlobalEnv) <span class="sc">%||%</span> <span class="st">"LOCAL"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># validate spatial_planning_unit</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>spu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>)) {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Unrecognized spatial_planning_unit = '"</span>, spu, <span class="st">"'. Falling back to 'adm2'."</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    spu <span class="ot">&lt;-</span> <span class="st">"adm2"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Which spatial columns to include in outputs / joins</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  spu_cols <span class="ot">&lt;-</span> <span class="cf">switch</span>(spu,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm1"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm2"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm3"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  sel_spu <span class="ot">&lt;-</span> <span class="cf">function</span>(...) dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, ...))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- CONSOLE SUMMARY ------------------------------------------------------</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Costing scenario being generated for the following mix of interventions:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  code_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^code_"</span>, <span class="fu">names</span>(scen_data), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(code_cols) <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No intervention columns starting with 'code_'; skipping summary.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    has1 <span class="ot">&lt;-</span> <span class="st">"adm1"</span> <span class="sc">%in%</span> <span class="fu">names</span>(scen_data)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    has2 <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(scen_data))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    has3 <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(scen_data))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    summary_tbl <span class="ot">&lt;-</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>      scen_data <span class="sc">%&gt;%</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(year)),</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm1_key =</span> <span class="cf">if</span> (has1) adm1 <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm2_key =</span> <span class="cf">if</span> (has2) <span class="fu">paste</span>(adm1, adm2, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm3_key =</span> <span class="cf">if</span> (has3) <span class="fu">paste</span>(adm1, adm2, adm3, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>          spu_cols, <span class="st">"year"</span>, <span class="st">"scenario_name"</span>, <span class="st">"scenario_description"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>          code_cols, <span class="st">"adm1_key"</span>, <span class="st">"adm2_key"</span>, <span class="st">"adm3_key"</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">all_of</span>(code_cols),</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"intervention"</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_prefix =</span> <span class="st">"code_"</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"included"</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">included =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.logical</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(included),</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.numeric</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(included <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.character</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(included)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"true"</span>, <span class="st">"yes"</span>, <span class="st">"y"</span>)),</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>L</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(included <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">%&gt;%</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(intervention, year) <span class="sc">%&gt;%</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm1_targeted =</span> <span class="cf">if</span> (has1) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm1_key[<span class="sc">!</span><span class="fu">is.na</span>(adm1_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm2_targeted =</span> <span class="cf">if</span> (has2) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm2_key[<span class="sc">!</span><span class="fu">is.na</span>(adm2_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm3_targeted =</span> <span class="cf">if</span> (has3) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm3_key[<span class="sc">!</span><span class="fu">is.na</span>(adm3_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(summary_tbl)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(scen_data<span class="sc">$</span>scenario_description[<span class="dv">1</span>] <span class="sc">%||%</span> <span class="st">""</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- COST DATA ------------------------------------------------------------</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  cost_data <span class="ot">&lt;-</span> cost_data <span class="sc">|&gt;</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(local_currency_cost)) <span class="sc">|&gt;</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cost_year_for_analysis =</span> <span class="fu">as.integer</span>(cost_year_for_analysis))</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  cost_data_expanded <span class="ot">&lt;-</span> scen_data <span class="sc">|&gt;</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">crossing</span>(cost_data) <span class="sc">|&gt;</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_year_for_analysis =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(cost_year_for_analysis), year, cost_year_for_analysis)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cost_year_for_analysis <span class="sc">==</span> year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="assumption-parsing-defaults" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="assumption-parsing-defaults"><span class="header-section-number">4.2</span> Assumption parsing &amp; defaults</h2>
<ul>
<li>Assumptions are parsed from labeled strings. Key labels include (examples):
<ul>
<li><strong>ITN Campaign</strong>: <code>people per net</code>, <code>nets per bale</code>, <code>buffer (%)</code>, <code>target population</code>, <code>target population coverage</code>.</li>
<li><strong>ITN Routine</strong>: <code>target population</code>, <code>target population coverage</code>, <code>buffer (%)</code>.</li>
<li><strong>IPTp</strong>: <code>ANC attendance</code>, <code>contact points</code>, <code>drug supply buffer</code>.</li>
<li><strong>SMC</strong>: <code>age targeting</code> (e.g., proportion of under 5 population aged 3-11 months or 12-59 months <code>"0.18,0.77"</code>), <code>cycles</code>, <code>target population coverage</code>, <code>drug supply buffer</code>.</li>
<li><strong>PMC</strong>: <code>coverage</code>, <code>contact points</code>, <code>nutrition scaling factor</code>, <code>drug supply buffer</code>.</li>
<li><strong>Vaccine</strong>: <code>coverage</code>, <code>number of doses</code>, <code>supply buffer</code>.</li>
</ul></li>
<li>Helper maps assumption labels like <strong>“Total population”</strong>, <strong>“Children under 5”</strong>, <strong>“Pregnant women”</strong> to canonical population columns in <code>target_population</code> (e.g., <code>pop_total</code>, <code>pop_0_5</code>, <code>pop_pw</code>, etc.).</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- ASSUMPTIONS ----------------------------------------------------------</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  assumptions <span class="ot">&lt;-</span> <span class="fu">unlist</span>(assumptions)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  target_population <span class="ot">&lt;-</span> target_population</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(assumptions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(assumptions) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    assumption_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(assumptions, <span class="sc">~</span>.x) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      rlang<span class="sc">::</span><span class="fu">set_names</span>(purrr<span class="sc">::</span><span class="fu">map_chr</span>(<span class="fu">strsplit</span>(assumptions, <span class="st">" = "</span>), <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">strsplit</span>(.x, <span class="st">" = "</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>])))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    assumption_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  get_assumption <span class="ot">&lt;-</span> <span class="cf">function</span>(label, default) {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(assumption_list[[label]])) assumption_list[[label]] <span class="cf">else</span> default</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  itn_campaign_divisor <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: people per net"</span>, <span class="fl">1.8</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  itn_campaign_bale_size <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: nets per bale"</span>, <span class="dv">50</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  itn_campaign_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: buffer (%)"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  itn_campaign_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: target population coverage"</span>, <span class="fl">1.00</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  itn_routine_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Routine: target population coverage"</span>, <span class="fl">0.30</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  itn_routine_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Routine: buffer (%)"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  iptp_anc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: ANC attendance"</span>, <span class="fl">0.80</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  iptp_doses_per_pw <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: contact points"</span>, <span class="dv">3</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  iptp_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  smc_age_string <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: age targeting"</span>, <span class="st">"0.18,0.77"</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  smc_split <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">strsplit</span>(smc_age_string, <span class="st">","</span>)[[<span class="dv">1</span>]])</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  smc_pop_prop_3_11 <span class="ot">&lt;-</span> smc_split[<span class="dv">1</span>]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  smc_pop_prop_12_59 <span class="ot">&lt;-</span> smc_split[<span class="dv">2</span>]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  smc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: target population coverage"</span>, <span class="fl">1.00</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  smc_monthly_rounds <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: cycles"</span>, <span class="dv">4</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  smc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  pmc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: coverage"</span>, <span class="fl">0.85</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  pmc_touchpoints <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: contact points"</span>, <span class="dv">4</span>)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  pmc_tablet_factor <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: nutrition scaling factor"</span>, <span class="fl">0.75</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  pmc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  vacc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: coverage"</span>, <span class="fl">0.84</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  vacc_doses_per_child <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: number of doses"</span>, <span class="dv">4</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  vacc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  get_pop_column <span class="ot">&lt;-</span> <span class="cf">function</span>(label, default_col) {</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    pop_assumption <span class="ot">&lt;-</span> assumption_list[[label]]</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(pop_assumption)) {</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(default_col)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    mapping <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Total population"</span>                           <span class="ot">=</span> <span class="st">"pop_total"</span>,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 5"</span>                           <span class="ot">=</span> <span class="st">"pop_0_5"</span>,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 5 and pregnant women"</span>        <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_pw"</span>),</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 10"</span>                          <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_5_10"</span>),</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 3 months to 5 years"</span>               <span class="ot">=</span> <span class="st">"pop_0_5"</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 3 months to 10 years"</span>              <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_5_10"</span>),</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 0-1"</span>                               <span class="ot">=</span> <span class="st">"pop_0_1"</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 1-2"</span>                               <span class="ot">=</span> <span class="st">"pop_1_2"</span>,</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 5-10"</span>                              <span class="ot">=</span> <span class="st">"pop_5_10"</span>,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 5–36 months"</span>                       <span class="ot">=</span> <span class="st">"pop_vaccine_5_36_months"</span>,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Pregnant women"</span>                             <span class="ot">=</span> <span class="st">"pop_pw"</span>,</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Urban population"</span>                           <span class="ot">=</span> <span class="st">"pop_urban"</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    mapped_col <span class="ot">&lt;-</span> mapping[[pop_assumption]]</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mapped_col)) {</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>      mapped_col</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Unrecognized target population assumption:"</span>, pop_assumption))</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>      default_col</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  itn_campaign_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"ITN Campaign: target population"</span>, <span class="st">"pop_total"</span>)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  itn_routine_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"ITN Routine: target population"</span>, <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_pw"</span>))</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  smc_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"SMC: target population"</span>, <span class="st">"pop_0_5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="quantification-by-intervention" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="quantification-by-intervention"><span class="header-section-number">4.3</span> Quantification by intervention</h2>
<p>Below, <code>target_pop</code> always reflects coverage-adjusted counts where applicable; units are normalized to friendly labels - that will match those that are specified in the drop down lists of the unit-cost template to allow for joining of commodity quantification data and unit cost data for cost calculations. All intervention quantifications are claculated at the level of the <code>spatial_planning_unit</code>.</p>
<section id="itn-campaign-code_itn_campaign" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="itn-campaign-code_itn_campaign"><span class="header-section-number">4.3.1</span> ITN — Campaign (<code>code_itn_campaign</code>)</h3>
<p>To estimate the number of insecticide-treated nets (ITNs) needed for campaign delivery in targeted areas:</p>
<p>The <strong>target population</strong> (default: total pop) of the area is multiplied by the <strong>target intervention coverage</strong> (default: 100%) to estimate the target population for the campaign and then divided by the <strong>number of people assumed to use 1 net</strong> (default: 1.8). A <strong>buffer</strong> (default: 10%) is applied to account for wastage and contingency. The number of <strong>bales</strong> is calculated by dividing the number of nets by 50 (assuming 50 nets per bale).</p>
<p><span class="math display">\[{ITNs Needed} =  \frac{(Target Population * Coverage)}{PeoplePerNet}Buffer  \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- ITN CAMPAIGN ----------------------------------------------------------</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  itn_campaign_quantifications <span class="ot">&lt;-</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"itn_campaign"</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_itn_campaign <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, itn_campaign_pop_col))),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_pop =</span> <span class="fu">sum</span>(dplyr<span class="sc">::</span><span class="fu">c_across</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_campaign_pop_col)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_campaign_pop_col)) <span class="sc">|&gt;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_nets =</span> ((target_pop <span class="sc">*</span> itn_campaign_coverage) <span class="sc">/</span> itn_campaign_divisor) <span class="sc">*</span> itn_campaign_buffer_mult,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_bales =</span> quant_nets <span class="sc">/</span> itn_campaign_bale_size,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> target_pop <span class="sc">*</span> itn_campaign_coverage,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"itn_campaign"</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_itn_campaign</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"nets"</span> <span class="sc">~</span> <span class="st">"per ITN"</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"bales"</span> <span class="sc">~</span> <span class="st">"per bale"</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="itn-routine-code_itn_routine" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="itn-routine-code_itn_routine"><span class="header-section-number">4.3.2</span> ITN — Routine (<code>code_itn_routine</code>)</h3>
<p>To estimate the number of nets needed for routine delivery channels often through ANC and EPI services, the <strong>target population</strong> (default: total under 5 and pregnant women population) of an area is multiplied by the <strong>expected routine distribution coverage</strong> (default: 30%) and a <strong>procurement buffer</strong> (default: 10%).</p>
<p><span class="math display">\[ITNs Needed =  Target Population * Coverage * Buffer  \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- ITN ROUTINE -----------------------------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  itn_routine_quantifications <span class="ot">&lt;-</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"itn_routine"</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_itn_routine <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, itn_routine_pop_col))),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_pop =</span> <span class="fu">sum</span>(dplyr<span class="sc">::</span><span class="fu">c_across</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_routine_pop_col)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_routine_pop_col)) <span class="sc">|&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_nets =</span> (target_pop <span class="sc">*</span> itn_routine_coverage) <span class="sc">*</span> itn_routine_buffer_mult,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"itn_routine"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_itn_routine</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"nets"</span> <span class="sc">~</span> <span class="st">"per ITN"</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"bales"</span> <span class="sc">~</span> <span class="st">"per bale"</span>,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="iptp-code_iptp" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="iptp-code_iptp"><span class="header-section-number">4.3.3</span> IPTp (<code>code_iptp</code>)</h3>
<p>To estimate the amount of SP (blister packs of 3 pills) to procure for IPTp we take the <strong>target population</strong> (default: pregnant women) of an area, multiply by the <strong>expected coverage at ANC attendence</strong> (default: 80%) for the scheduled number of <strong>touchpoints</strong> per woman (default: 3) and multiply this by a <strong>procurement buffer</strong> (default: 10%).</p>
<p><span class="math display">\[SP Quantity =  Target Population * Coverage * Touch Points * Buffer  \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- IPTp ------------------------------------------------------------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  iptp_quantifications <span class="ot">&lt;-</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"iptp"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_iptp <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_pw"</span>))),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_sp_doses =</span> ((pop_pw <span class="sc">*</span> iptp_anc_coverage) <span class="sc">*</span> iptp_doses_per_pw) <span class="sc">*</span> iptp_buffer_mult,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> pop_pw,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"iptp"</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_iptp</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(unit <span class="sc">==</span> <span class="st">"sp_doses"</span> <span class="sc">~</span> <span class="st">"per SP"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> unit))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="smc-code_smc" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="smc-code_smc"><span class="header-section-number">4.3.4</span> SMC (<code>code_smc</code>)</h3>
<p>To estimate the number of SP+AQ co-blistered packets required for Seasonal Malaria Chemoprevention (SMC), we use the following methodology with the default assumptions included here for clarity. We first assume each packet contains one full course for a single cycle (1 tablet of SP and 3 tablets of AQ). SMC is at default delivered over 4 <strong>monthly cycles</strong> and <em>targets two age groups</em>: children aged 3 to &lt;12 months and children aged &gt;12 to 59 months. We include the distribution of age-groups as the procurement costs of the co-blistered packets for these different age groups vary as a result of the age-based dosing requirements for SMC drugs.</p>
<p>We first estimate the <strong>target population</strong> by applying fixed proportions to the total number of children under 5 years of age. <strong>Coverage</strong> of the target population is assumed to be 100%, unless otherwise specified, and is applied before the buffer is calculated. A <strong>10% buffer</strong> is then included to account for re-dosing, wastage, and the treatment of children from outside the catchment area.</p>
<p><span class="math display">\[SMCBlisterPacks_{age-group} =  (TargetPopulation_{age-group} * Coverage * Monthly Cycles) * Buffer \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- SMC -------------------------------------------------------------------</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  include_5_10 <span class="ot">&lt;-</span> <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"5_10"</span>, smc_pop_col))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  smc_quantification <span class="ot">&lt;-</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"smc"</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_smc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, smc_pop_col))),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_3_11_months =</span> ((pop_0_5 <span class="sc">*</span> smc_pop_prop_3_11) <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_12_59_months =</span> ((pop_0_5 <span class="sc">*</span> smc_pop_prop_12_59) <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_5_10_years =</span> <span class="cf">if</span> (include_5_10) (pop_5_10 <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_child =</span> <span class="cf">if</span> (include_5_10) {</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        ((pop_0_5 <span class="sc">*</span> (smc_pop_prop_3_11 <span class="sc">+</span> smc_pop_prop_12_59)) <span class="sc">+</span> pop_5_10) <span class="sc">*</span> smc_coverage</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        (pop_0_5 <span class="sc">*</span> (smc_pop_prop_3_11 <span class="sc">+</span> smc_pop_prop_12_59)) <span class="sc">*</span> smc_coverage</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> quant_smc_child,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"smc"</span>,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_smc</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_smc_"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_3_11_months"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 3-11 month olds"</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_12_59_months"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 12-59 month olds"</span>,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_5_10_years"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 5–10 years old"</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="pmc-code_pmc" class="level3" data-number="4.3.5">
<h3 data-number="4.3.5" class="anchored" data-anchor-id="pmc-code_pmc"><span class="header-section-number">4.3.5</span> PMC (<code>code_pmc</code>)</h3>
<p>To estimate the quantity of sulfadoxine-pyrimethamine (SP) required for Perennial Malaria Chemoprevention (PMC), we assume delivery is integrated into routine Expanded Programme on Immunization (EPI). Each eligible child receives SP at four routine immunization touchpoints per year, with age-specific dosing:</p>
<ul>
<li><p>Children aged <strong>0–1 years</strong> receive <strong>1 tablet</strong> of SP per contact.</p></li>
<li><p>Children aged <strong>1–2 years</strong> receive <strong>2 tablets</strong> of SP per contact.</p></li>
</ul>
<p>To account for <strong>underdosing due to low weight</strong>, which affects approximately <strong>25% of children in each age group</strong>, a <strong>scaling factor of 0.75</strong> is applied to both age groups. This factor reflects the average reduction in tablets required due to dose adjustment (e.g., half tablets for underweight infants).</p>
<p>An <strong>85% coverage rate</strong> is assumed and a <strong>10% procurement buffer</strong> is then included to cover wastage, re-dosing, and stockouts.</p>
<p><span class="math display">\[SP Quantity = [(pop_{0-1} * tablet_{0-1}) + (pop_{1-2} * tablet_{1-2})] * Coverage * ScalingFactor * Touchpoints * Buffer \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PMC -------------------------------------------------------------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  pmc_quantification <span class="ot">&lt;-</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"pmc"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_pmc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_0_1"</span>, <span class="st">"pop_1_2"</span>))),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_0_1_years =</span> pop_0_1 <span class="sc">*</span> pmc_coverage <span class="sc">*</span> pmc_touchpoints <span class="sc">*</span> pmc_tablet_factor <span class="sc">*</span> pmc_buffer_mult,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_1_2_years =</span> pop_1_2 <span class="sc">*</span> pmc_coverage <span class="sc">*</span> pmc_touchpoints <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pmc_tablet_factor <span class="sc">*</span> pmc_buffer_mult,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_total     =</span> quant_pmc_sp_0_1_years <span class="sc">+</span> quant_pmc_sp_1_2_years,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_child        =</span> pop_0_1 <span class="sc">*</span> pmc_coverage <span class="sc">+</span> pop_1_2 <span class="sc">*</span> pmc_coverage,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop             =</span> quant_pmc_child,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention      =</span> <span class="st">"pmc"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention      =</span> type_pmc</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>quant_pmc_sp_0_1_years, <span class="sc">-</span>quant_pmc_sp_1_2_years) <span class="sc">|&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_pmc_"</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"sp_total"</span> <span class="sc">~</span> <span class="st">"per SP"</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="vaccine-code_vacc" class="level3" data-number="4.3.6">
<h3 data-number="4.3.6" class="anchored" data-anchor-id="vaccine-code_vacc"><span class="header-section-number">4.3.6</span> Vaccine (<code>code_vacc</code>)</h3>
<p>To estimate the number of malaria vaccine doses required, at default, we assume each eligible child will receive a <strong>4-dose schedule</strong>. Assuming the first three doses are delivered monthly and start around 5 months of age and the 4th dose is delivered ~12 – 15 months following the 3rd dose. The vaccine is delivered through <em>routine immunization contacts</em> with an <strong>expected coverage of 84%</strong> among the target population. A 10% buffer is included to account for losses during transportation, storage, and administration.</p>
<p><span class="math display">\[VaccineDoses = Target Pop * Coverage * DosesPerChild * Buffer \]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- VACCINE ---------------------------------------------------------------</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  vacc_quantification <span class="ot">&lt;-</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"vacc"</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_vacc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_vaccine_5_36_months"</span>))),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_vacc_doses =</span> pop_vaccine_5_36_months <span class="sc">*</span> vacc_coverage <span class="sc">*</span> vacc_buffer_mult <span class="sc">*</span> vacc_doses_per_child,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_vacc_child =</span> pop_vaccine_5_36_months <span class="sc">*</span> vacc_coverage,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> quant_vacc_child,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"vacc"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_vacc</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_vacc_"</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"doses"</span> <span class="sc">~</span> <span class="st">"per dose"</span>,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="baseline-assumptions-defaults-summary" class="level3" data-number="4.3.7">
<h3 data-number="4.3.7" class="anchored" data-anchor-id="baseline-assumptions-defaults-summary"><span class="header-section-number">4.3.7</span> Baseline assumptions (defaults summary)</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Parameter</th>
<th style="text-align: right;">Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>people_per_net</code></td>
<td style="text-align: right;">1.8</td>
<td>ITN campaign</td>
</tr>
<tr class="even">
<td><code>itn_campaign_cov</code></td>
<td style="text-align: right;">1.00</td>
<td>100% of total population</td>
</tr>
<tr class="odd">
<td><code>nets_per_bale</code></td>
<td style="text-align: right;">50</td>
<td></td>
</tr>
<tr class="even">
<td><code>buffer</code></td>
<td style="text-align: right;">0.10</td>
<td>applied post‑coverage</td>
</tr>
<tr class="odd">
<td><code>itn_routine_cov</code></td>
<td style="text-align: right;">0.30</td>
<td>of U5 + pregnant women</td>
</tr>
<tr class="even">
<td><code>iptp_anc_cov</code></td>
<td style="text-align: right;">0.80</td>
<td>ANC attendance proxy</td>
</tr>
<tr class="odd">
<td><code>iptp_touchpoints</code></td>
<td style="text-align: right;">3</td>
<td>per pregnancy</td>
</tr>
<tr class="even">
<td><code>smc_cycles</code></td>
<td style="text-align: right;">4</td>
<td>monthly</td>
</tr>
<tr class="odd">
<td><code>smc_cov</code></td>
<td style="text-align: right;">1.00</td>
<td>of target population</td>
</tr>
<tr class="even">
<td><code>u5_split_3_11</code></td>
<td style="text-align: right;">0.18</td>
<td>fraction of U5</td>
</tr>
<tr class="odd">
<td><code>u5_split_12_59</code></td>
<td style="text-align: right;">0.77</td>
<td>fraction of U5</td>
</tr>
<tr class="even">
<td><code>pmc_touchpoints</code></td>
<td style="text-align: right;">4</td>
<td>via EPI</td>
</tr>
<tr class="odd">
<td><code>pmc_nutrition_factor</code></td>
<td style="text-align: right;">0.75</td>
<td>dose scaling</td>
</tr>
<tr class="even">
<td><code>pmc_cov</code></td>
<td style="text-align: right;">0.85</td>
<td>EPI coverage</td>
</tr>
<tr class="odd">
<td><code>vac_doses_per_child</code></td>
<td style="text-align: right;">4</td>
<td>RTS,S or R21</td>
</tr>
<tr class="even">
<td><code>vac_cov</code></td>
<td style="text-align: right;">0.84</td>
<td>EPI coverage</td>
</tr>
<tr class="odd">
<td><code>vac_wastage</code></td>
<td style="text-align: right;">0.10</td>
<td>buffer/wastage</td>
</tr>
</tbody>
</table>
<p>Users may override any parameter via the specific selections in the UI.</p>
</section>
</section>
<section id="intervention-costing" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="intervention-costing"><span class="header-section-number">4.4</span> Intervention costing</h2>
<p>Quantified dataframes get joined with the <code>cost_data_expanded</code> (accounting for the years in the scenario), and are joined on <code>c("code_intervention", "type_intervention", "unit", "year" = "cost_year_for_analysis")</code>.</p>
<p>Once joined we simply pivot longer to ensure we have one row for each of the different <code>currency</code> types and costs are calculated by multiplying the <code>quantity * unit_cost</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- COMBINE &amp; COST --------------------------------------------------------</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  budget <span class="ot">&lt;-</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(itn_campaign_quantifications),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(itn_routine_quantifications),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(iptp_quantifications),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(smc_quantification),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(pmc_quantification),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(vacc_quantification)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      cost_data_expanded <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year, <span class="sc">-</span>original_unit_cost),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"code_intervention"</span>, <span class="st">"type_intervention"</span>, <span class="st">"unit"</span>, <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"cost_year_for_analysis"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">"_cost"</span>),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"currency"</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">"unit_cost"</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_element =</span> quantity <span class="sc">*</span> unit_cost,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">currency =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(currency <span class="sc">==</span> <span class="st">"usd_cost"</span>, <span class="st">"USD"</span>, local_symbol),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_nice =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_public"</span> <span class="sc">~</span> <span class="st">"Case Management Public"</span>,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_private"</span> <span class="sc">~</span> <span class="st">"Case Management Private"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"iptp"</span> <span class="sc">~</span> <span class="st">"IPTp"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"vacc"</span> <span class="sc">~</span> <span class="st">"Vaccine"</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_routine"</span> <span class="sc">~</span> <span class="st">"Routine ITN"</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_campaign"</span> <span class="sc">~</span> <span class="st">"Campaign ITN"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"smc"</span> <span class="sc">~</span> <span class="st">"SMC"</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"pmc"</span> <span class="sc">~</span> <span class="st">"PMC"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"irs"</span> <span class="sc">~</span> <span class="st">"IRS"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"lsm"</span> <span class="sc">~</span> <span class="st">"LSM"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> code_intervention</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(spu_cols), year,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>      cost_name, cost_description,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>      code_intervention, type_intervention,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>      target_pop, unit, quantity,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>      cost_class, currency, unit_cost, cost_element,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      intervention_nice</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cost_element <span class="sc">!=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 14%">
<col style="width: 85%">
</colgroup>
<thead>
<tr class="header">
<th>Intervention</th>
<th>Cost Component Examples</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ITN Campaign</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = Number of nets × unit cost per net.</p></li>
<li><p><strong>Delivery cost</strong> = Number of nets or bales x unit delivery cost per net or bale.</p></li>
<li><p><strong>Operational campaign costs</strong> = Number of nets × operational cost per net.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>ITN Routine</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = Number of nets × unit cost per net.</p></li>
<li><p><strong>Delivery cost</strong> = Number of nets x unit delivery cost per net.</p></li>
<li><p><strong>Operational costs</strong> = Number of nets × operational cost per net.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>IPTp</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = SP quantity × procurement unit cost per SP.</p></li>
<li><p><strong>Delivery cost</strong> = SP quantity x delivery unit cost per SP.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>SMC</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = SP+AQ quantity × procurement unit cost per SP+AQ.</p></li>
<li><p><strong>Delivery cost</strong> = SP+AQ quantity x delivery unit cost per SP+AQ.</p></li>
<li><p><strong>Operational cost</strong> = Target Population x operational unit cost per child.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>PMC</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = SP quantity × procurement unit cost per SP.</p></li>
<li><p><strong>Delivery cost</strong> = SP quantity x delivery unit cost per SP.</p></li>
<li><p><strong>Operational cost</strong> = Target Population x operational unit cost per child or per SP.</p></li>
</ul></td>
</tr>
<tr class="even">
<td>Vaccine</td>
<td><ul>
<li><p><strong>Procurement cost</strong> = Dose quantity × procurement unit cost per dose.</p></li>
<li><p><strong>Delivery cost</strong> = Dose quantity x delivery unit cost per dose.</p></li>
<li><p><strong>Operational cost</strong> = Target Population x operational unit cost per child.</p></li>
</ul></td>
</tr>
</tbody>
</table>
</section>
<section id="fixed-costs" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="fixed-costs"><span class="header-section-number">4.5</span> Fixed Costs</h2>
<p>Fixed costs (do not vary directly with units delivered), we currently have fixed costs implemented minimally but these will be <strong>further developed</strong> once we understand expected fixed costs from country programs.</p>
<ol type="1">
<li><strong>Lump sum Nationally</strong> : Include as an interventio specific single line in the final budget that will be incorporated when summing budgets at the national level .</li>
<li><strong>Embedded in unit costs</strong>: incorporate within delivery or procurement unit costs during costing.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed costs (national-level currently)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  fixed_budget <span class="ot">&lt;-</span> cost_data_expanded <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(type_intervention <span class="sc">==</span> <span class="st">"Fixed cost"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">"_cost"</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"currency"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">"unit_cost"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">currency =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(currency <span class="sc">==</span> <span class="st">"usd_cost"</span>, <span class="st">"USD"</span>, local_symbol),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">adm1 =</span> <span class="cn">NA_character_</span>, <span class="at">adm2 =</span> <span class="cn">NA_character_</span>, <span class="at">adm3 =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> <span class="fu">unique</span>(scen_data<span class="sc">$</span>scenario_name)[<span class="dv">1</span>],</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_description =</span> <span class="fu">unique</span>(scen_data<span class="sc">$</span>scenario_description)[<span class="dv">1</span>],</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_name =</span> cost_data<span class="sc">$</span>cost_name[<span class="dv">1</span>],</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_description =</span> cost_data<span class="sc">$</span>cost_description[<span class="dv">1</span>],</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">quantity =</span> <span class="dv">1</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_element =</span> unit_cost <span class="sc">*</span> quantity,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_nice =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_public"</span> <span class="sc">~</span> <span class="st">"Case Management Public"</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_private"</span> <span class="sc">~</span> <span class="st">"Case Management Private"</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"iptp"</span> <span class="sc">~</span> <span class="st">"IPTp"</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"vacc"</span> <span class="sc">~</span> <span class="st">"Vaccine"</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_routine"</span> <span class="sc">~</span> <span class="st">"Routine ITN"</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_campaign"</span> <span class="sc">~</span> <span class="st">"Campaign ITN"</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"smc"</span> <span class="sc">~</span> <span class="st">"SMC"</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"pmc"</span> <span class="sc">~</span> <span class="st">"PMC"</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"irs"</span> <span class="sc">~</span> <span class="st">"IRS"</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"lsm"</span> <span class="sc">~</span> <span class="st">"LSM"</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> code_intervention</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      adm1, adm2, adm3, year,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      cost_name, cost_description,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      code_intervention, type_intervention,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      target_pop, unit, quantity,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      cost_class, currency, unit_cost, cost_element,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      intervention_nice</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="output-data-frame" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="output-data-frame"><span class="header-section-number">4.6</span> Output data frame</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>budget_final <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(budget, fixed_budget) <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      spu_cols, <span class="st">"year"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"scenario_name"</span>, <span class="st">"scenario_description"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cost_name"</span>, <span class="st">"cost_description"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"code_intervention"</span>, <span class="st">"type_intervention"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"target_pop"</span>, <span class="st">"unit"</span>, <span class="st">"quantity"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cost_class"</span>, <span class="st">"currency"</span>, <span class="st">"unit_cost"</span>, <span class="st">"cost_element"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"intervention_nice"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ASSUMPTION SUMMARY &amp; PLAN ID -----------------------------------------</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  assumption_summary <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(assumption_list) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">names</span>(assumption_list), <span class="fu">unlist</span>(assumption_list), <span class="at">sep =</span> <span class="st">" = "</span>, <span class="at">collapse =</span> <span class="st">"; "</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"default values"</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  budget_final <span class="ot">&lt;-</span> budget_final <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">assumptions_changes =</span> assumption_summary,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">assumption_type =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(assumption_summary <span class="sc">==</span> <span class="st">"default values"</span>, <span class="st">"baseline assumptions"</span>, <span class="st">"adjusted assumptions"</span>),</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">plan_id =</span> <span class="fu">paste0</span>(scenario_name, <span class="st">" with "</span>, cost_name, <span class="st">" with "</span>, assumption_type),</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">plan_id =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        assumption_type <span class="sc">==</span> <span class="st">"adjusted assumptions"</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(plan_id, <span class="st">" ("</span>, assumptions_changes, <span class="st">")"</span>),</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        plan_id</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final return</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(budget_final)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Final budget dataframe includes the following columns:</p>
<pre><code> [1] "adm1"                 "adm2"                
 [3] "adm3"                 "year"                
 [5] "scenario_name"        "scenario_description"
 [7] "cost_name"            "cost_description"    
 [9] "code_intervention"    "type_intervention"   
[11] "target_pop"           "unit"                
[13] "quantity"             "cost_class"          
[15] "currency"             "unit_cost"           
[17] "cost_element"         "intervention_nice"   
[19] "assumptions_changes"  "assumption_type"     
[21] "plan_id"              "file_path"    </code></pre>
<p>This dataset is kept at the <code>spatial_planning_unit</code> scale and with <strong>itemised interventio cost components</strong>. During the visualisation component of our tool is when data is aggregated up to give us a National summary of the total expected cost for a scenario along with intervention specific total costs.</p>
<div id="nte-missing" class="callout callout-style-default callout-note callout-titled" title="Missing Methodology">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;2: Missing Methodology
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>IRS</strong> (quantification &amp; costing): wall surface area, sprayable structures, insecticide sachets, spray days, teams, PPE, transport, subnational rotation of insecticides.
<ul>
<li><p>To estimate the amount of insecticide required for an IRS spray round, the following is needed: N: number of houses to be sprayed (expressed as the percentage of modern and traditional structures); S: average sprayable surface per house in m2 (modern and traditional structures); C: concentration of AI in the formulation (% AI); and Y: target dosage, expressed in g/m2 (application rate), of insecticide to be used on each type of structure according to the product’s label.</p>
<p>Insecticide needed = (S * Y * 100 / C) * N</p></li>
</ul></li>
<li><strong>Case management</strong>: incidence‑based quantification (RDTs, ACTs, Severe malaria treatments (Artesunate, RAS) and consumables), facility vs community delivery mixes, private sector subsidies.</li>
<li><strong>MDA:</strong> Target population, Number of rounds, Number of doses, Coverage Buffer and expected drug types (different to first line treatment).</li>
<li><strong>Larval Source Management</strong> (quantification and costing): depending on approach to be used (habitat modification, larviciding, biological control.</li>
<li><strong>Surveillance/M&amp;E</strong>: entomological monitoring, routine surveillance strengthening.</li>
<li><strong>Funding source assignment</strong>: mapping lines to funders for gap analysis.</li>
<li><strong>Subnational unit costs</strong>: full support for SPU‑scoped cost lines in joins.</li>
<li><strong>Plus Others directed by the program</strong></li>
</ul>
<p>Each item will be integrated with the same pattern: <strong>quantify → multiply by unit costs → aggregate</strong> or <strong>fixed cost approach</strong></p>
<p>In addidition we still need to improve our current coding functionality to allow some more flexibility in matching unit costs correctly and clean our codebase/ stress test this further.</p>
</div>
</div>
</section>
</section>
<section id="full-core-function" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Full core function</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># File: helpers/10-generate-budget.R</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Purpose: Budget generation: quantify requirements, apply unit costs, build long budget</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Depends on: dplyr, tidyr, purrr, tibble, rlang, tidyselect, stats; internal: `%||%` (from 00-utils-base.R); globals: spatial_planning_unit, local_currency_symbol, target_population</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate detailed intervention budget from scenarios &amp; costs</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' Quantifies product/service needs from scenario coverage, applies unit costs,</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' and returns a long-form budget suitable for tables/maps/plots.</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scen_data Data frame of implementation scenarios. Must include columns:</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - Spatial keys: `adm1`, `adm2` (and optionally `adm3`) depending on SPU.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - `year`, `scenario_name`, `scenario_description`</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - intervention code columns like `code_itn_campaign`, `code_itn_routine`, `code_iptp`,</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'     `code_smc`, `code_pmc`, `code_vacc`, and corresponding `type_*` columns.</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cost_data Data frame of unit/delivery costs containing at least:</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `code_intervention`, `type_intervention`, `unit`, `local_currency_cost`, `usd_cost`,</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   and `cost_year_for_analysis` (may be NA, in which case it is matched to scenario year).</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param assumptions Character vector of "Label = value" strings; optional.</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with columns (subset depending on SPU):\n#'   `adm1`, `adm2`, `adm3`, `year`, `scenario_name`, `scenario_description`,\n#'   `cost_name`, `cost_description`, `code_intervention`, `type_intervention`,\n#'   `target_pop`, `unit`, `quantity`, `cost_class`, `currency`, `unit_cost`,\n#'   `cost_element`, `intervention_nice`, `assumptions_changes`, `assumption_type`, `plan_id`.</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Expects global `spatial_planning_unit` to be set to "adm1"/"adm2"/"adm3".</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Expects global `local_currency_symbol` (used to label non-USD currency rows).</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Expects global `target_population` table with the necessary population columns.</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Assumption parsing: strings of form `"Label = value"` are evaluated on the right-hand side.</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Fixed costs in `cost_data` (where `type_intervention == "Fixed cost"`) are applied nationally.</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Output keeps both currencies by pivoting cost columns to `currency` and `unit_cost`.</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' @family helpers-budget</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>generate_budget <span class="ot">&lt;-</span> <span class="cf">function</span>(scen_data, cost_data, assumptions) {</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ENV OPTIONS ----------------------------------------------------------</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># spatial level + currency symbol</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  spu <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"spatial_planning_unit"</span>, <span class="at">envir =</span> .GlobalEnv) <span class="sc">%||%</span> <span class="st">"adm2"</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  local_symbol <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">"local_currency_symbol"</span>, <span class="at">envir =</span> .GlobalEnv) <span class="sc">%||%</span> <span class="st">"LOCAL"</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># validate spatial_planning_unit</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>spu <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>)) {</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Unrecognized spatial_planning_unit = '"</span>, spu, <span class="st">"'. Falling back to 'adm2'."</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    spu <span class="ot">&lt;-</span> <span class="st">"adm2"</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Which spatial columns to include in outputs / joins</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  spu_cols <span class="ot">&lt;-</span> <span class="cf">switch</span>(spu,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm1"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm2"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adm3"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  sel_spu <span class="ot">&lt;-</span> <span class="cf">function</span>(...) dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, ...))</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- CONSOLE SUMMARY ------------------------------------------------------</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Costing scenario being generated for the following mix of interventions:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  code_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^code_"</span>, <span class="fu">names</span>(scen_data), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(code_cols) <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No intervention columns starting with 'code_'; skipping summary.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    has1 <span class="ot">&lt;-</span> <span class="st">"adm1"</span> <span class="sc">%in%</span> <span class="fu">names</span>(scen_data)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    has2 <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(scen_data))</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    has3 <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"adm1"</span>, <span class="st">"adm2"</span>, <span class="st">"adm3"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(scen_data))</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    summary_tbl <span class="ot">&lt;-</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>      scen_data <span class="sc">%&gt;%</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(year)),</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm1_key =</span> <span class="cf">if</span> (has1) adm1 <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm2_key =</span> <span class="cf">if</span> (has2) <span class="fu">paste</span>(adm1, adm2, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm3_key =</span> <span class="cf">if</span> (has3) <span class="fu">paste</span>(adm1, adm2, adm3, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>          spu_cols, <span class="st">"year"</span>, <span class="st">"scenario_name"</span>, <span class="st">"scenario_description"</span>,</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>          code_cols, <span class="st">"adm1_key"</span>, <span class="st">"adm2_key"</span>, <span class="st">"adm3_key"</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">all_of</span>(code_cols),</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"intervention"</span>,</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_prefix =</span> <span class="st">"code_"</span>,</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"included"</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">included =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.logical</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(included),</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.numeric</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(included <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.character</span>(included) <span class="sc">~</span> <span class="fu">as.integer</span>(<span class="fu">tolower</span>(<span class="fu">trimws</span>(included)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"true"</span>, <span class="st">"yes"</span>, <span class="st">"y"</span>)),</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>L</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(included <span class="sc">==</span> <span class="dv">1</span>L) <span class="sc">%&gt;%</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(intervention, year) <span class="sc">%&gt;%</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm1_targeted =</span> <span class="cf">if</span> (has1) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm1_key[<span class="sc">!</span><span class="fu">is.na</span>(adm1_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm2_targeted =</span> <span class="cf">if</span> (has2) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm2_key[<span class="sc">!</span><span class="fu">is.na</span>(adm2_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm3_targeted =</span> <span class="cf">if</span> (has3) dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(adm3_key[<span class="sc">!</span><span class="fu">is.na</span>(adm3_key)]) <span class="cf">else</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(summary_tbl)</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(scen_data<span class="sc">$</span>scenario_description[<span class="dv">1</span>] <span class="sc">%||%</span> <span class="st">""</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- COST DATA ------------------------------------------------------------</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>  cost_data <span class="ot">&lt;-</span> cost_data <span class="sc">|&gt;</span></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(local_currency_cost)) <span class="sc">|&gt;</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cost_year_for_analysis =</span> <span class="fu">as.integer</span>(cost_year_for_analysis))</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>  cost_data_expanded <span class="ot">&lt;-</span> scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">crossing</span>(cost_data) <span class="sc">|&gt;</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_year_for_analysis =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(cost_year_for_analysis), year, cost_year_for_analysis)</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cost_year_for_analysis <span class="sc">==</span> year)</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ASSUMPTIONS ----------------------------------------------------------</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>  assumptions <span class="ot">&lt;-</span> <span class="fu">unlist</span>(assumptions)</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>  target_population <span class="ot">&lt;-</span> target_population</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(assumptions) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(assumptions) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    assumption_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(assumptions, <span class="sc">~</span>.x) <span class="sc">|&gt;</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>      rlang<span class="sc">::</span><span class="fu">set_names</span>(purrr<span class="sc">::</span><span class="fu">map_chr</span>(<span class="fu">strsplit</span>(assumptions, <span class="st">" = "</span>), <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">strsplit</span>(.x, <span class="st">" = "</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>])))</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    assumption_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>  get_assumption <span class="ot">&lt;-</span> <span class="cf">function</span>(label, default) {</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(assumption_list[[label]])) assumption_list[[label]] <span class="cf">else</span> default</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  itn_campaign_divisor <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: people per net"</span>, <span class="fl">1.8</span>)</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>  itn_campaign_bale_size <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: nets per bale"</span>, <span class="dv">50</span>)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>  itn_campaign_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: buffer (%)"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>  itn_campaign_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Campaign: target population coverage"</span>, <span class="fl">1.00</span>)</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>  itn_routine_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Routine: target population coverage"</span>, <span class="fl">0.30</span>)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>  itn_routine_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"ITN Routine: buffer (%)"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>  iptp_anc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: ANC attendance"</span>, <span class="fl">0.80</span>)</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>  iptp_doses_per_pw <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: contact points"</span>, <span class="dv">3</span>)</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>  iptp_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"IPTp: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>  smc_age_string <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: age targeting"</span>, <span class="st">"0.18,0.77"</span>)</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>  smc_split <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">strsplit</span>(smc_age_string, <span class="st">","</span>)[[<span class="dv">1</span>]])</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>  smc_pop_prop_3_11 <span class="ot">&lt;-</span> smc_split[<span class="dv">1</span>]</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>  smc_pop_prop_12_59 <span class="ot">&lt;-</span> smc_split[<span class="dv">2</span>]</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>  smc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: target population coverage"</span>, <span class="fl">1.00</span>)</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>  smc_monthly_rounds <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: cycles"</span>, <span class="dv">4</span>)</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>  smc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"SMC: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>  pmc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: coverage"</span>, <span class="fl">0.85</span>)</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>  pmc_touchpoints <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: contact points"</span>, <span class="dv">4</span>)</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>  pmc_tablet_factor <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: nutrition scaling factor"</span>, <span class="fl">0.75</span>)</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>  pmc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"PMC: drug supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>  vacc_coverage <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: coverage"</span>, <span class="fl">0.84</span>)</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>  vacc_doses_per_child <span class="ot">&lt;-</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: number of doses"</span>, <span class="dv">4</span>)</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>  vacc_buffer_mult <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">get_assumption</span>(<span class="st">"Vaccine: supply buffer"</span>, <span class="fl">0.10</span>)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>  get_pop_column <span class="ot">&lt;-</span> <span class="cf">function</span>(label, default_col) {</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>    pop_assumption <span class="ot">&lt;-</span> assumption_list[[label]]</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(pop_assumption)) {</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(default_col)</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>    mapping <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Total population"</span>                           <span class="ot">=</span> <span class="st">"pop_total"</span>,</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 5"</span>                           <span class="ot">=</span> <span class="st">"pop_0_5"</span>,</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 5 and pregnant women"</span>        <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_pw"</span>),</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children under 10"</span>                          <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_5_10"</span>),</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 3 months to 5 years"</span>               <span class="ot">=</span> <span class="st">"pop_0_5"</span>,</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 3 months to 10 years"</span>              <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_5_10"</span>),</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 0-1"</span>                               <span class="ot">=</span> <span class="st">"pop_0_1"</span>,</span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 1-2"</span>                               <span class="ot">=</span> <span class="st">"pop_1_2"</span>,</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 5-10"</span>                              <span class="ot">=</span> <span class="st">"pop_5_10"</span>,</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Children 5–36 months"</span>                       <span class="ot">=</span> <span class="st">"pop_vaccine_5_36_months"</span>,</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Pregnant women"</span>                             <span class="ot">=</span> <span class="st">"pop_pw"</span>,</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Urban population"</span>                           <span class="ot">=</span> <span class="st">"pop_urban"</span></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>    mapped_col <span class="ot">&lt;-</span> mapping[[pop_assumption]]</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mapped_col)) {</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>      mapped_col</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Unrecognized target population assumption:"</span>, pop_assumption))</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>      default_col</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>  itn_campaign_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"ITN Campaign: target population"</span>, <span class="st">"pop_total"</span>)</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>  itn_routine_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"ITN Routine: target population"</span>, <span class="fu">c</span>(<span class="st">"pop_0_5"</span>, <span class="st">"pop_pw"</span>))</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>  smc_pop_col <span class="ot">&lt;-</span> <span class="fu">get_pop_column</span>(<span class="st">"SMC: target population"</span>, <span class="st">"pop_0_5"</span>)</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- QUANTIFICATION HELPERS -----------------------------------------------</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>  join_keys <span class="ot">&lt;-</span> spu_cols</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>  safe_quantification <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>      tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        <span class="at">adm1 =</span> <span class="fu">character</span>(), <span class="at">adm2 =</span> <span class="fu">character</span>(), <span class="at">adm3 =</span> <span class="fu">character</span>(), <span class="at">year =</span> <span class="fu">integer</span>(),</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> <span class="fu">character</span>(), <span class="at">scenario_description =</span> <span class="fu">character</span>(),</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>        <span class="at">code_intervention =</span> <span class="fu">character</span>(), <span class="at">type_intervention =</span> <span class="fu">character</span>(),</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>        <span class="at">target_pop =</span> <span class="fu">numeric</span>(), <span class="at">unit =</span> <span class="fu">character</span>(), <span class="at">quantity =</span> <span class="fu">numeric</span>()</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>      df</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ITN CAMPAIGN ----------------------------------------------------------</span></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>  itn_campaign_quantifications <span class="ot">&lt;-</span></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"itn_campaign"</span>),</span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_itn_campaign <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, itn_campaign_pop_col))),</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_pop =</span> <span class="fu">sum</span>(dplyr<span class="sc">::</span><span class="fu">c_across</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_campaign_pop_col)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_campaign_pop_col)) <span class="sc">|&gt;</span></span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_nets =</span> ((target_pop <span class="sc">*</span> itn_campaign_coverage) <span class="sc">/</span> itn_campaign_divisor) <span class="sc">*</span> itn_campaign_buffer_mult,</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_bales =</span> quant_nets <span class="sc">/</span> itn_campaign_bale_size,</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> target_pop <span class="sc">*</span> itn_campaign_coverage,</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"itn_campaign"</span>,</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_itn_campaign</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"nets"</span> <span class="sc">~</span> <span class="st">"per ITN"</span>,</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"bales"</span> <span class="sc">~</span> <span class="st">"per bale"</span>,</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ITN ROUTINE -----------------------------------------------------------</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>  itn_routine_quantifications <span class="ot">&lt;-</span></span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"itn_routine"</span>),</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_itn_routine <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, itn_routine_pop_col))),</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">target_pop =</span> <span class="fu">sum</span>(dplyr<span class="sc">::</span><span class="fu">c_across</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_routine_pop_col)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(itn_routine_pop_col)) <span class="sc">|&gt;</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_nets =</span> (target_pop <span class="sc">*</span> itn_routine_coverage) <span class="sc">*</span> itn_routine_buffer_mult,</span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"itn_routine"</span>,</span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_itn_routine</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"nets"</span> <span class="sc">~</span> <span class="st">"per ITN"</span>,</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>      unit <span class="sc">==</span> <span class="st">"bales"</span> <span class="sc">~</span> <span class="st">"per bale"</span>,</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- IPTp ------------------------------------------------------------------</span></span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>  iptp_quantifications <span class="ot">&lt;-</span></span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"iptp"</span>),</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_iptp <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_pw"</span>))),</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_sp_doses =</span> ((pop_pw <span class="sc">*</span> iptp_anc_coverage) <span class="sc">*</span> iptp_doses_per_pw) <span class="sc">*</span> iptp_buffer_mult,</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> pop_pw,</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"iptp"</span>,</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_iptp</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_"</span></span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(unit <span class="sc">==</span> <span class="st">"sp_doses"</span> <span class="sc">~</span> <span class="st">"per SP"</span>, <span class="cn">TRUE</span> <span class="sc">~</span> unit))</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- SMC -------------------------------------------------------------------</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>  include_5_10 <span class="ot">&lt;-</span> <span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"5_10"</span>, smc_pop_col))</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>  smc_quantification <span class="ot">&lt;-</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"smc"</span>),</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_smc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, smc_pop_col))),</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_3_11_months =</span> ((pop_0_5 <span class="sc">*</span> smc_pop_prop_3_11) <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult,</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_12_59_months =</span> ((pop_0_5 <span class="sc">*</span> smc_pop_prop_12_59) <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult,</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_spaq_5_10_years =</span> <span class="cf">if</span> (include_5_10) (pop_5_10 <span class="sc">*</span> smc_coverage) <span class="sc">*</span> smc_monthly_rounds <span class="sc">*</span> smc_buffer_mult <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_smc_child =</span> <span class="cf">if</span> (include_5_10) {</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>        ((pop_0_5 <span class="sc">*</span> (smc_pop_prop_3_11 <span class="sc">+</span> smc_pop_prop_12_59)) <span class="sc">+</span> pop_5_10) <span class="sc">*</span> smc_coverage</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>        (pop_0_5 <span class="sc">*</span> (smc_pop_prop_3_11 <span class="sc">+</span> smc_pop_prop_12_59)) <span class="sc">*</span> smc_coverage</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> quant_smc_child,</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"smc"</span>,</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_smc</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_smc_"</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_3_11_months"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 3-11 month olds"</span>,</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_12_59_months"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 12-59 month olds"</span>,</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"spaq_5_10_years"</span> <span class="sc">~</span> <span class="st">"per SPAQ pack 5–10 years old"</span>,</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- PMC -------------------------------------------------------------------</span></span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>  pmc_quantification <span class="ot">&lt;-</span></span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"pmc"</span>),</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_pmc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_0_1"</span>, <span class="st">"pop_1_2"</span>))),</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_0_1_years =</span> pop_0_1 <span class="sc">*</span> pmc_coverage <span class="sc">*</span> pmc_touchpoints <span class="sc">*</span> pmc_tablet_factor <span class="sc">*</span> pmc_buffer_mult,</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_1_2_years =</span> pop_1_2 <span class="sc">*</span> pmc_coverage <span class="sc">*</span> pmc_touchpoints <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pmc_tablet_factor <span class="sc">*</span> pmc_buffer_mult,</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_sp_total     =</span> quant_pmc_sp_0_1_years <span class="sc">+</span> quant_pmc_sp_1_2_years,</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_pmc_child        =</span> pop_0_1 <span class="sc">*</span> pmc_coverage <span class="sc">+</span> pop_1_2 <span class="sc">*</span> pmc_coverage,</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop             =</span> quant_pmc_child,</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention      =</span> <span class="st">"pmc"</span>,</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention      =</span> type_pmc</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>quant_pmc_sp_0_1_years, <span class="sc">-</span>quant_pmc_sp_1_2_years) <span class="sc">|&gt;</span></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_pmc_"</span></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"sp_total"</span> <span class="sc">~</span> <span class="st">"per SP"</span>,</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- VACCINE ---------------------------------------------------------------</span></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>  vacc_quantification <span class="ot">&lt;-</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>    scen_data <span class="sc">|&gt;</span></span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>)), dplyr<span class="sc">::</span><span class="fu">contains</span>(<span class="st">"vacc"</span>),</span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description</span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(code_vacc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>      target_population <span class="sc">|&gt;</span></span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(spu_cols, <span class="st">"year"</span>, <span class="st">"pop_vaccine_5_36_months"</span>))),</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(stats<span class="sc">::</span><span class="fu">setNames</span>(join_keys, join_keys), <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_vacc_doses =</span> pop_vaccine_5_36_months <span class="sc">*</span> vacc_coverage <span class="sc">*</span> vacc_buffer_mult <span class="sc">*</span> vacc_doses_per_child,</span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant_vacc_child =</span> pop_vaccine_5_36_months <span class="sc">*</span> vacc_coverage,</span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> quant_vacc_child,</span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>      <span class="at">code_intervention =</span> <span class="st">"vacc"</span>,</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_intervention =</span> type_vacc</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">"quant"</span>),</span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"unit"</span>, <span class="at">values_to =</span> <span class="st">"quantity"</span>, <span class="at">names_prefix =</span> <span class="st">"quant_vacc_"</span></span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>      <span class="at">unit =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"doses"</span> <span class="sc">~</span> <span class="st">"per dose"</span>,</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>        unit <span class="sc">==</span> <span class="st">"child"</span> <span class="sc">~</span> <span class="st">"per child"</span>,</span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> unit</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- COMBINE &amp; COST --------------------------------------------------------</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>  budget <span class="ot">&lt;-</span></span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(itn_campaign_quantifications),</span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(itn_routine_quantifications),</span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(iptp_quantifications),</span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(smc_quantification),</span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(pmc_quantification),</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>      <span class="fu">safe_quantification</span>(vacc_quantification)</span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>      cost_data_expanded <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year, <span class="sc">-</span>original_unit_cost),</span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"code_intervention"</span>, <span class="st">"type_intervention"</span>, <span class="st">"unit"</span>, <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"cost_year_for_analysis"</span>)</span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">"_cost"</span>),</span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"currency"</span>,</span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">"unit_cost"</span></span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_element =</span> quantity <span class="sc">*</span> unit_cost,</span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>      <span class="at">currency =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(currency <span class="sc">==</span> <span class="st">"usd_cost"</span>, <span class="st">"USD"</span>, local_symbol),</span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_nice =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_public"</span> <span class="sc">~</span> <span class="st">"Case Management Public"</span>,</span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_private"</span> <span class="sc">~</span> <span class="st">"Case Management Private"</span>,</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"iptp"</span> <span class="sc">~</span> <span class="st">"IPTp"</span>,</span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"vacc"</span> <span class="sc">~</span> <span class="st">"Vaccine"</span>,</span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_routine"</span> <span class="sc">~</span> <span class="st">"Routine ITN"</span>,</span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_campaign"</span> <span class="sc">~</span> <span class="st">"Campaign ITN"</span>,</span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"smc"</span> <span class="sc">~</span> <span class="st">"SMC"</span>,</span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"pmc"</span> <span class="sc">~</span> <span class="st">"PMC"</span>,</span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"irs"</span> <span class="sc">~</span> <span class="st">"IRS"</span>,</span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"lsm"</span> <span class="sc">~</span> <span class="st">"LSM"</span>,</span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> code_intervention</span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">all_of</span>(spu_cols), year,</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description,</span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a>      cost_name, cost_description,</span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>      code_intervention, type_intervention,</span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a>      target_pop, unit, quantity,</span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>      cost_class, currency, unit_cost, cost_element,</span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a>      intervention_nice</span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cost_element <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fixed costs (national-level currently)</span></span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a>  fixed_budget <span class="ot">&lt;-</span> cost_data_expanded <span class="sc">|&gt;</span></span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(type_intervention <span class="sc">==</span> <span class="st">"Fixed cost"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a>      <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">"_cost"</span>),</span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">"currency"</span>,</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">"unit_cost"</span></span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>      <span class="at">currency =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(currency <span class="sc">==</span> <span class="st">"usd_cost"</span>, <span class="st">"USD"</span>, local_symbol),</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>      <span class="at">adm1 =</span> <span class="cn">NA_character_</span>, <span class="at">adm2 =</span> <span class="cn">NA_character_</span>, <span class="at">adm3 =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> <span class="fu">unique</span>(scen_data<span class="sc">$</span>scenario_name)[<span class="dv">1</span>],</span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_description =</span> <span class="fu">unique</span>(scen_data<span class="sc">$</span>scenario_description)[<span class="dv">1</span>],</span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_name =</span> cost_data<span class="sc">$</span>cost_name[<span class="dv">1</span>],</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_description =</span> cost_data<span class="sc">$</span>cost_description[<span class="dv">1</span>],</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>      <span class="at">target_pop =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">quantity =</span> <span class="dv">1</span>,</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>      <span class="at">cost_element =</span> unit_cost <span class="sc">*</span> quantity,</span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_nice =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_public"</span> <span class="sc">~</span> <span class="st">"Case Management Public"</span>,</span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"cm_private"</span> <span class="sc">~</span> <span class="st">"Case Management Private"</span>,</span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"iptp"</span> <span class="sc">~</span> <span class="st">"IPTp"</span>,</span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"vacc"</span> <span class="sc">~</span> <span class="st">"Vaccine"</span>,</span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_routine"</span> <span class="sc">~</span> <span class="st">"Routine ITN"</span>,</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"itn_campaign"</span> <span class="sc">~</span> <span class="st">"Campaign ITN"</span>,</span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"smc"</span> <span class="sc">~</span> <span class="st">"SMC"</span>,</span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"pmc"</span> <span class="sc">~</span> <span class="st">"PMC"</span>,</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"irs"</span> <span class="sc">~</span> <span class="st">"IRS"</span>,</span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>        code_intervention <span class="sc">==</span> <span class="st">"lsm"</span> <span class="sc">~</span> <span class="st">"LSM"</span>,</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> code_intervention</span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>      adm1, adm2, adm3, year,</span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a>      scenario_name, scenario_description,</span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>      cost_name, cost_description,</span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a>      code_intervention, type_intervention,</span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a>      target_pop, unit, quantity,</span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a>      cost_class, currency, unit_cost, cost_element,</span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>      intervention_nice</span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>  budget_final <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(budget, fixed_budget) <span class="sc">|&gt;</span></span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>      spu_cols, <span class="st">"year"</span>,</span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>      <span class="st">"scenario_name"</span>, <span class="st">"scenario_description"</span>,</span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cost_name"</span>, <span class="st">"cost_description"</span>,</span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>      <span class="st">"code_intervention"</span>, <span class="st">"type_intervention"</span>,</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>      <span class="st">"target_pop"</span>, <span class="st">"unit"</span>, <span class="st">"quantity"</span>,</span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cost_class"</span>, <span class="st">"currency"</span>, <span class="st">"unit_cost"</span>, <span class="st">"cost_element"</span>,</span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>      <span class="st">"intervention_nice"</span></span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>    )))</span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ASSUMPTION SUMMARY &amp; PLAN ID -----------------------------------------</span></span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>  assumption_summary <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(assumption_list) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">names</span>(assumption_list), <span class="fu">unlist</span>(assumption_list), <span class="at">sep =</span> <span class="st">" = "</span>, <span class="at">collapse =</span> <span class="st">"; "</span>)</span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>    <span class="st">"default values"</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>  budget_final <span class="ot">&lt;-</span> budget_final <span class="sc">|&gt;</span></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a>      <span class="at">assumptions_changes =</span> assumption_summary,</span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>      <span class="at">assumption_type =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(assumption_summary <span class="sc">==</span> <span class="st">"default values"</span>, <span class="st">"baseline assumptions"</span>, <span class="st">"adjusted assumptions"</span>),</span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>      <span class="at">plan_id =</span> <span class="fu">paste0</span>(scenario_name, <span class="st">" with "</span>, cost_name, <span class="st">" with "</span>, assumption_type),</span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>      <span class="at">plan_id =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(</span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>        assumption_type <span class="sc">==</span> <span class="st">"adjusted assumptions"</span>,</span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(plan_id, <span class="st">" ("</span>, assumptions_changes, <span class="st">")"</span>),</span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>        plan_id</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(budget_final)</span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","selector":".lightbox","descPosition":"bottom","loop":false});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>